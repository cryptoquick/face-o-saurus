<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>FACE-O-SAURUS</title>
	
	<script src="lib/compatibility.js"></script>
	<script src="lib/smoother.js"></script>
	
	<script src="lib/objectdetect.js"></script>
	<script src="lib/objectdetect.frontalface.js"></script>
	<script src="lib/objectdetect.mouth.js"></script>
  <script src="lib/objectdetect.eye.js"></script>
  
	<script src="http://code.jquery.com/jquery-1.8.0.min.js"></script>
	<script src="lib/jquery.objectdetect.js"></script>
  <!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
  <script src="lib/raphael.js"></script>
  
	<script>
    ///////
    
    var rate = 100; // (ms)
    
    ///////
    var objs = [];
    $(function () {
      var paper = Raphael(0, 0, 800, 600);
      
      /*   for (var f = 0; f < 4; f++) {
        var face = draw.group().attr('class', 'face');
        var f1 = face.circle(25);
        var f2 = face.circle(25);
        var f3 = face.circle(25);
        var f4 = face.circle(25);
        f1.center(-100,   0);
        f2.center( 100,   0);
        f3.center( -75, 100);
        f4.center(  75, 100);
        
        faces.push(face);
      }*/
      
      //var face = draw.path('M-100,0 L-75,100 L75,100 L100,0 z');
      var head = paper.set();
      head.push(paper.path('M0,100 L30,200 L170,200 L200,100 z')); // nose
      head.push(paper.path('M25,100 L75,0 L125,0 L175,100 z')); // forehead
      head.attr('fill', 'green');
      head.attr('stroke', 'none');
      objs.head = head;
      
      var mouth = paper.rect(0, 0, 100, 50);
      head.push(mouth);
      //mouth.transform('t100,150');
      mouth.attr({fill: 'white', stroke: 'none'});
      objs.mouth = mouth;
      
      var leye = paper.circle(50, 80, 25);
      var reye = paper.circle(150, 80, 25);
      leye.attr({fill: 'white', stroke: 'none'});
      reye.attr({fill: 'white', stroke: 'none'});
      head.push(leye, reye);
      //leye.transform('t75,125');
      //reye.transform('t125,125');
      objs.leye = leye;
      objs.reye = reye;
    });
    
    /////// object detect //////////
    
    var smoother = new Smoother(0.85, [0, 0, 0, 0, 0]);
    
    $(window).load(function() {
      
      var video = $("#video").get(0);
      try {
        compatibility.getUserMedia({video: true}, function(stream) {
          try {
            video.src = compatibility.URL.createObjectURL(stream);
          } catch (error) {
            video.src = stream;
          }
          video.play();
          //compatibility.requestAnimationFrame(tick);
          animate();
        }, function (error) {
          alert("WebRTC not available");
        });
      } catch (error) {
        alert(error);
      }
      
      tick = function (headcb, mouthcb, eyescb) {
        //  compatibility.requestAnimationFrame(tick);
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          $(video).objectdetect("all", {scaleMin: 3, scaleFactor: 1.1, classifier: objectdetect.frontalface}, function(coords) {
            coors = coords.map(function (h) {
              return {
                  left:    ~~(h[0] + h[2] * 1.0/8),
                  top:     ~~(h[1] + h[3] * 0.8/8),
                  width:   ~~(h[2] * 6/8),
                  height:  ~~(h[3] * 6/8)
                };
            });
            headcb(coors);
          });
          $(video).objectdetect("all", {scaleMin: 3, scaleFactor: 1.1, classifier: objectdetect.mouth}, function(coords) {
            //  console.log('mouth', coords);
            mcoors = coords.map(function (m) {
              return {
                  left:    ~~(m[0]),
                  top:     ~~(m[1]),
                  width:   ~~(m[2]),
                  height:  ~~(m[3])
                };
            });
            mouthcb(mcoors);
          });
          $(video).objectdetect("all", {scaleMin: 3, scaleFactor: 1.1, classifier: objectdetect.eye}, function(coords) {
            // console.log('eyes', coords);
            ecoors = coords.map(function (m) {
              return {
                  left:    ~~(m[0]),
                  top:     ~~(m[1]),
                  width:   ~~(m[2]),
                  height:  ~~(m[3])
                };
            });
            eyescb(ecoors);
          });
        }
        else {
          setTimeout(function () { animate() }, rate);
        }
      }
      
      $("#list img").click(function () {
        $("#glasses").attr("src", $(this).attr("src"));
      });
    });
    
    function animate () {
      /// 1. head
      tick(function (coors) {
        if (!coors.length) {
          setTimeout(function () { animate() }, rate);
          return;
        }
        
        var coor = coors[0];
        
        if (coor) {
          objs.head.transform('t' + (coor.left + coor.width / 2) + ',' + (coor.top + coor.height / 2) + 's' + coor.width / 100 + ',' + coor.height / 100)
          //.after(function () {
            setTimeout(animate, 100);
          //});
        }
      },
      /// 2. mouth
      function (coors) {
        var mouth = coors[0];
        
        if (mouth) {
          // objs.mouth.transform('s' + mouth.width / 100 + ',' + mouth.height / 100)
          objs.mouth.transform('t' + (mouth.left + mouth.width / 2) + ',' + (mouth.top + mouth.height / 2) + 's' + mouth.width / 100 + ',' + mouth.height / 100)
        }
      },
      /// 3. eyes
      function (coors) {
        console.log(coors);
        
        var lcoors = coors[0];
        var rcoors = coors[1];
        
        if (lcoors) {
          objs.leye.transform('s' + lcoors.width / 100 + ',' + lcoors.height / 100);
          //objs.leye.transform('t' + (lcoors.left + lcoors.width / 2) + ',' + (lcoors.top + lcoors.height / 2) + 's' + lcoors.width / 100 + ',' + lcoors.height / 100)
        }
        if (rcoors) {
          objs.reye.transform('s' + rcoors.width / 100 + ',' + rcoors.height / 100);
          //objs.reye.transform('t' + (rcoors.left + rcoors.width / 2) + ',' + (rcoors.top + rcoors.height / 2) + 's' + rcoors.width / 100 + ',' + rcoors.height / 100)
        }
      });
    }

</script>
</head>

<body bgcolor="tomato">
  <video id="video" style="position: absolute; left: 0px; top: 0px;" width="800" height="600"></video>
  <h1 style="position: absolute; right: 50px; top: 10px; font-size: 100px; font-family: Comic Sans MS">FACE-O-SAURUS</h1>
</body>
</html>