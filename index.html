<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>FACE-O-SAURUS</title>
	
	<script src="lib/compatibility.js"></script>
	<script src="lib/smoother.js"></script>
	
	<script src="lib/objectdetect.js"></script>
	<script src="lib/objectdetect.frontalface.js"></script>
	<script src="lib/objectdetect.mouth.js"></script>
  <script src="lib/objectdetect.eye.js"></script>
  
	<script src="http://code.jquery.com/jquery-1.8.0.min.js"></script>
	<script src="lib/jquery.objectdetect.js"></script>
  <!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
  <script src="lib/svg.js"></script>
  
  <style>

.link {
  stroke: #000;
  stroke-width: 1.5px;
}

.node {
  fill: #000;
  stroke: #fff;
  stroke-width: 1.5px;
}

.node.a { fill: #1f77b4; }
.node.b { fill: #ff7f0e; }
.node.c { fill: #2ca02c; }

</style>
	<script>
    ///////
    
    var rate = 100; // (ms)
    
    ///////
    var objs = [];
    $(function () {
      var draw = SVG('canvas');
      draw.size(800, 600);
      
      var faces = [];
      
      /*   for (var f = 0; f < 4; f++) {
        var face = draw.group().attr('class', 'face');
        var f1 = face.circle(25);
        var f2 = face.circle(25);
        var f3 = face.circle(25);
        var f4 = face.circle(25);
        f1.center(-100,   0);
        f2.center( 100,   0);
        f3.center( -75, 100);
        f4.center(  75, 100);
        
        faces.push(face);
      }*/
      
      //var face = draw.path('M-100,0 L-75,100 L75,100 L100,0 z');
      var face = draw.group();
      var nose = face.path('M0,100 L30,200 L170,200 L200,100 z');
      var head = face.path('M25,100 L75,0 L125,0 L175,100 z');
      nose.fill('green');
      head.fill('green');
      
      // face = draw.group().attr('class', 'face');
      // faces = [face];
      objs.face = face;
      //  objs.face.mouth = face.group();
      
      objs.mouth = objs.face.rect(100, 50);
      objs.mouth.center(100, 150);
      objs.mouth.fill('white');
      
      objs.leye = face.circle(25);
      objs.reye = face.circle(25);
      objs.leye.attr('fill', 'white');
      objs.reye.attr('fill', 'white');
      //  objs.f1 = f1, objs.f2 = f2, objs.f3 = f3, objs.f4 = f4;
    });
    
    /////// object detect //////////
    
    var smoother = new Smoother(0.85, [0, 0, 0, 0, 0]);
    
    $(window).load(function() {
      
      var video = $("#video").get(0);
      try {
        compatibility.getUserMedia({video: true}, function(stream) {
          try {
            video.src = compatibility.URL.createObjectURL(stream);
          } catch (error) {
            video.src = stream;
          }
          video.play();
          //compatibility.requestAnimationFrame(tick);
          animate();
        }, function (error) {
          alert("WebRTC not available");
        });
      } catch (error) {
        alert(error);
      }
      
      tick = function (facecb, mouthcb, eyescb) {
        //  compatibility.requestAnimationFrame(tick);
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          $(video).objectdetect("all", {scaleMin: 3, scaleFactor: 1.1, classifier: objectdetect.frontalface}, function(coords) {
            coors = coords.map(function (face) {
              return {
                  left:    ~~(face[0] + face[2] * 1.0/8),
                  top:     ~~(face[1] + face[3] * 0.8/8),
                  width:   ~~(face[2] * 6/8),
                  height:  ~~(face[3] * 6/8)
                };
            });
            facecb(coors);
          });
          $(video).objectdetect("all", {scaleMin: 3, scaleFactor: 1.1, classifier: objectdetect.mouth}, function(coords) {
            //  console.log('mouth', coords);
            mcoors = coords.map(function (m) {
              return {
                  left:    ~~(m[0]),
                  top:     ~~(m[1]),
                  width:   ~~(m[2]),
                  height:  ~~(m[3])
                };
            });
            mouthcb(mcoors);
          });
          $(video).objectdetect("all", {scaleMin: 3, scaleFactor: 1.1, classifier: objectdetect.eye}, function(coords) {
            // console.log('eyes', coords);
            ecoors = coords.map(function (m) {
              return {
                  left:    ~~(m[0]),
                  top:     ~~(m[1]),
                  width:   ~~(m[2]),
                  height:  ~~(m[3])
                };
            });
            eyescb(ecoors);
          });
        }
        else {
          setTimeout(function () { animate() }, rate);
        }
      }
      
      $("#list img").click(function () {
        $("#glasses").attr("src", $(this).attr("src"));
      });
    });
    
    function animate () {
      /// 1. face
      tick(function (coors) {
        if (!coors.length) {
          setTimeout(function () { animate() }, rate);
          return;
        }
        
        var face = objs.face;
        var coor = coors[0];
        
        if (coor) {
          // console.log(coor.left, coor.top, coor.width / 100, coor.height / 100);
          
          //   face.show();
          objs.face.animate(rate).move(coor.left, coor.top).scale(coor.width / 100, coor.height / 100).after(function () {
            animate();
          });
        }
        else {
          // face.hide();
        }
      },
      /// 2. mouth
      function (coors) {
        var mouth = coors[0];
        
        if (mouth) {
          objs.mouth.animate(rate).scale(mouth.width / 100, mouth.height / 100)
        }
        // else
          // objs.face.mouth.animate(rate).scale(0,0);
      },
      /// 3. eyes
      function (coors) {
        console.log(coors);
        
        var lcoors = coors[0];
        var rcoors = coors[1];
        
        if (lcoors) {
          objs.leye.animate(rate).center(lcoors.left - objs.face.bbox().x, lcoors.top - objs.face.bbox().y).scale(lcoors.width / 100, lcoors.height / 100);
        }
        if (rcoors) {
          objs.reye.animate(rate).center(rcoors.left - objs.face.bbox().x, rcoors.top - objs.face.bbox().y).scale(rcoors.width / 100, rcoors.height / 100);
        }
      });
    }

</script>
</head>

<body>
	<h1>FACE-O-SAURUS</h1>
  <video id="video" style="position: absolute; left: 0px; top: 0px;" width="800" height="600"></video>
  <div id="canvas" style="position: absolute; left: 0px; top: 0px;"></div>
<!--	<img id="glasses" src="img/sunglasses_0.png" style="position:absolute; display:none"> -->
</body>
</html>